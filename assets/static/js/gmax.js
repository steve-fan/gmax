"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function i(s,a,d){function c(t,e){if(!a[t]){if(!s[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(l)return l(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var o=a[t]={exports:{}};s[t][0].call(o.exports,function(e){return c(s[t][1][e]||e)},o,o.exports,i,s,a,d)}return a[t].exports}for(var l="function"==typeof require&&require,e=0;e<d.length;e++)c(d[e]);return c}({1:[function(e,t,n){var r,o;r=this,o=function(a){var t="URLSearchParams"in self,n="Symbol"in self&&"iterator"in Symbol,d="FileReader"in self&&"Blob"in self&&function(){try{return new Blob,!0}catch(e){return!1}}(),r="FormData"in self,o="ArrayBuffer"in self;if(o)var i=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],s=ArrayBuffer.isView||function(e){return e&&-1<i.indexOf(Object.prototype.toString.call(e))};function c(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function l(e){return"string"!=typeof e&&(e=String(e)),e}function e(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return n&&(e[Symbol.iterator]=function(){return e}),e}function u(t){this.map={},t instanceof u?t.forEach(function(e,t){this.append(t,e)},this):Array.isArray(t)?t.forEach(function(e){this.append(e[0],e[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function h(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function f(n){return new Promise(function(e,t){n.onload=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function p(e){var t=new FileReader,n=f(t);return t.readAsArrayBuffer(e),n}function y(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function m(){return this.bodyUsed=!1,this._initBody=function(e){(this._bodyInit=e)?"string"==typeof e?this._bodyText=e:d&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:r&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:t&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():o&&d&&function(e){return e&&DataView.prototype.isPrototypeOf(e)}(e)?(this._bodyArrayBuffer=y(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):o&&(ArrayBuffer.prototype.isPrototypeOf(e)||s(e))?this._bodyArrayBuffer=y(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):t&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},d&&(this.blob=function(){var e=h(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?h(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(p)}),this.text=function(){var e=h(this);if(e)return e;if(this._bodyBlob)return function(e){var t=new FileReader,n=f(t);return t.readAsText(e),n}(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),r=0;r<t.length;r++)n[r]=String.fromCharCode(t[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},r&&(this.formData=function(){return this.text().then(w)}),this.json=function(){return this.text().then(JSON.parse)},this}u.prototype.append=function(e,t){e=c(e),t=l(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},u.prototype.delete=function(e){delete this.map[c(e)]},u.prototype.get=function(e){return e=c(e),this.has(e)?this.map[e]:null},u.prototype.has=function(e){return this.map.hasOwnProperty(c(e))},u.prototype.set=function(e,t){this.map[c(e)]=l(t)},u.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},u.prototype.keys=function(){var n=[];return this.forEach(function(e,t){n.push(t)}),e(n)},u.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),e(t)},u.prototype.entries=function(){var n=[];return this.forEach(function(e,t){n.push([t,e])}),e(n)},n&&(u.prototype[Symbol.iterator]=u.prototype.entries);var b=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function v(e,t){var n=(t=t||{}).body;if(e instanceof v){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new u(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,n||null==e._bodyInit||(n=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new u(t.headers)),this.method=function(e){var t=e.toUpperCase();return-1<b.indexOf(t)?t:e}(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(n)}function w(e){var o=new FormData;return e.trim().split("&").forEach(function(e){if(e){var t=e.split("="),n=t.shift().replace(/\+/g," "),r=t.join("=").replace(/\+/g," ");o.append(decodeURIComponent(n),decodeURIComponent(r))}}),o}function g(e,t){t=t||{},this.type="default",this.status=void 0===t.status?200:t.status,this.ok=200<=this.status&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new u(t.headers),this.url=t.url||"",this._initBody(e)}v.prototype.clone=function(){return new v(this,{body:this._bodyInit})},m.call(v.prototype),m.call(g.prototype),g.prototype.clone=function(){return new g(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new u(this.headers),url:this.url})},g.error=function(){var e=new g(null,{status:0,statusText:""});return e.type="error",e};var _=[301,302,303,307,308];g.redirect=function(e,t){if(-1===_.indexOf(t))throw new RangeError("Invalid status code");return new g(null,{status:t,headers:{location:e}})},a.DOMException=self.DOMException;try{new a.DOMException}catch(e){a.DOMException=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack},a.DOMException.prototype=Object.create(Error.prototype),a.DOMException.prototype.constructor=a.DOMException}function E(i,s){return new Promise(function(n,e){var t=new v(i,s);if(t.signal&&t.signal.aborted)return e(new a.DOMException("Aborted","AbortError"));var r=new XMLHttpRequest;function o(){r.abort()}r.onload=function(){var e={status:r.status,statusText:r.statusText,headers:function(e){var o=new u;return e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(e){var t=e.split(":"),n=t.shift().trim();if(n){var r=t.join(":").trim();o.append(n,r)}}),o}(r.getAllResponseHeaders()||"")};e.url="responseURL"in r?r.responseURL:e.headers.get("X-Request-URL");var t="response"in r?r.response:r.responseText;n(new g(t,e))},r.onerror=function(){e(new TypeError("Network request failed"))},r.ontimeout=function(){e(new TypeError("Network request failed"))},r.onabort=function(){e(new a.DOMException("Aborted","AbortError"))},r.open(t.method,t.url,!0),"include"===t.credentials?r.withCredentials=!0:"omit"===t.credentials&&(r.withCredentials=!1),"responseType"in r&&d&&(r.responseType="blob"),t.headers.forEach(function(e,t){r.setRequestHeader(t,e)}),t.signal&&(t.signal.addEventListener("abort",o),r.onreadystatechange=function(){4===r.readyState&&t.signal.removeEventListener("abort",o)}),r.send(void 0===t._bodyInit?null:t._bodyInit)})}E.polyfill=!0,self.fetch||(self.fetch=E,self.Headers=u,self.Request=v,self.Response=g),a.Headers=u,a.Request=v,a.Response=g,a.fetch=E,Object.defineProperty(a,"__esModule",{value:!0})},"object"===_typeof(n)&&void 0!==t?o(n):"function"==typeof define&&define.amd?define(["exports"],o):o(r.WHATWGFetch={})},{}],2:[function(e,t,n){e("whatwg-fetch");var h="http://localhost:3000";window.onload=function(){function u(e,t){var n={buttonClicked:e,email:t},r=h+"/api/users/status?"+jQuery.param(n);return window.fetch(r,{credentials:"include"}).then(function(e){return e})}InboxSDK.load(2,"sdk_gmaxapp_915e4f0b24").then(function(d){console.log("GMAX 加载中，请稍候...");var o,i,s,a,e,c=d.User.getEmailAddress();function r(e){var t=10,n=$("#google_oauth2_container").bPopup(),r=setInterval(function(){(t-=1)<0?(clearInterval(r),n.close(),d.ButterBar.showMessage({text:"长时间未连接 Google 账号，请稍候重试。",time:3e3})):u(!1,e).then(function(e){200==e.status&&(clearInterval(r),n.close(),d.ButterBar.showMessage({text:"成功连接 Google 账号",time:5e3}))})},2e3)}function l(e,t,n,r){var o;o=n?{email:e,draftId:t,sheetId:n,emailField:r}:{email:e,draftId:t};return window.fetch("http://localhost:3000/api/drafts/send",{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}console.log("GMAX 加载完成，你当前的电子邮箱是 "+c+"。"),function(){var e=document.createElement("div");e.style.display="none",e.id="empty_recipients",e.innerHTML="请检查邮件主题和收件人列表，这些信息不能为空。",document.body.appendChild(e);var t=document.createElement("div");t.style.display="none",t.id="too_many_recipients",t.innerHTML="收件人地址不能超过 4000 个",document.body.appendChild(t);var n=document.createElement("div");n.style.display="none",n.id="send_draft_process",n.innerHTML='<div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>',document.body.appendChild(n);var r=document.createElement("div");r.style.display="none",r.id="sheet-select-container",r.innerHTML='<div class="select-wrapper"><div>选择包含邮件字段的文件</div><select id="sheet-select"></select></div><div class="select-wrapper"><div>邮件字段名称</div><select id="field-select"></select></div><div><button class="mdc-button mdc-button--primary mdc-button__disabled mr">确定并前往编辑邮件</button><button class="mdc-button mdc-button--outlined">取消</button></div>',document.body.appendChild(r),$("#sheet-select").on("select2:select",function(e){var t=e.params.data;o=t.id;$("#field-select").select2({dropdownParent:$("#sheet-select-container"),ajax:{url:h+"/api/sheets/"+t.id+"/headers?email="+c,dataType:"json",processResults:function(e){return{results:e.headers}}}});$("#field-select").select2("open")}),$("#field-select").on("select2:select",function(e){var t=e.params.data;i=t.text;var n=document.querySelector("#sheet-select").value,r=document.querySelector("#sheet-select-container .mdc-button--primary");null!=n&&null!=n&&""!=n?r.classList.remove("mdc-button__disabled"):r.classList.add("mdc-button__disabled")}),$("#sheet-select-container .mdc-button--primary").on("click",function(n){var r="mdc-button__disabled";if(!n.target.classList.contains(r)){n.target.classList.add(r),n.target.textContent="正在加载电子邮箱列表...";var e={field:i,email:c},t=h+"/api/sheets/"+o+"/values?"+jQuery.param(e);window.fetch(t,{credentials:"include"}).then(function(e){return e.json()}).then(function(e){s&&s.close();var t=e.values;d.Compose.openNewComposeView().then(function(e){e.sheetId=o,e.emailField=i,e.setToRecipients([t])}),n.target.classList.remove(r),n.target.textContent="确定并前往编辑邮件"})}}),$("#sheet-select-container .mdc-button--outlined").on("click",function(e){s&&s.close()})}(),a=c,(e=document.createElement("div")).setAttribute("id","google_oauth2_container"),e.innerHTML='<div id="oauth2_note">你必须先使用 Google 账户登录才能使用 Gmax 的功能。</div><div id="google_oauth2_button">连接 Google 账号</div>',document.body.appendChild(e),document.getElementById("google_oauth2_button").addEventListener("click",function(){var e=window.screenLeft?window.screenLeft:window.screenX,t=window.screenTop?window.screenTop:window.screenY,n=e+window.innerWidth/2-300,r="width=600, height=800, top="+(t+window.innerHeight/2-400)+", left="+n,o=h+"/auth/google?email="+a;window.open(o,"ConnectGoogle",r)}),function(){var e=document.querySelector("[role='search']").parentElement.parentElement,t=document.createElement("div");t.id="gmax-button-container";var n=document.createElement("div");n.id="gmax-import",n.innerHTML='<svg data-icon="th" width="20" height="20" viewBox="0 0 20 20" style="color: #D44638"><desc>th</desc><path d="M19 1H1c-.6 0-1 .5-1 1v16c0 .5.4 1 1 1h18c.5 0 1-.5 1-1V2c0-.5-.5-1-1-1zM7 17H2v-3h5v3zm0-4H2v-3h5v3zm0-4H2V6h5v3zm11 8H8v-3h10v3zm0-4H8v-3h10v3zm0-4H8V6h10v3z" fill-rule="evenodd"></path></svg>',n.style.cursor="pointer",n.title="从 Google Spreadsheet 中导入邮箱",n.addEventListener("click",function(e){u(!0,c).then(function(e){200==e.status?(s=$("#sheet-select-container").bPopup(),$("#sheet-select").select2({dropdownParent:$("#sheet-select-container"),ajax:{url:h+"/api/sheets?email="+c,dataType:"json",processResults:function(e){return{results:e.sheets}}}})):r(c)})}),t.appendChild(n),e.insertBefore(t,e.lastChild)}();try{d.Compose.registerComposeViewHandler(function(a){a.isInlineReplyForm()||a.addButton({title:"点击 GMAX 按钮，邮件将被单独发送至收件人中的每一个邮箱",type:"SEND_ACTION",iconClass:"gmax-send-btn",onClick:function(i){var s=d.User.getEmailAddress();u(!0,s).then(function(e){if(200==e.status){var t=a.getToRecipients();t.length<1?$("#empty_recipients").bPopup():4e3<t.length?$("#recipient_overload").bPopup():a.getCurrentDraftID().then(function(e){var t="",n=$("#send_draft_process").bPopup({}),r=a.sheetId,o=a.emailField;null==e||null==e?a.getDraftID().then(function(e){t=e,a.setMinimized(!0),l(s,t,r,o).then(function(e){200==e.status?(i.composeView.close(),n.close(),d.ButterBar.showMessage({text:"GMAX 正在发送邮件，你可以前往已发送标签查看。",time:5e3})):d.ButterBar.showMessage({text:"发送失败，请稍后重试！",time:1e4})})}):(t=e,a.setMinimized(!0),l(s,t,r,o).then(function(e){200==e.status?(i.composeView.close(),n.close(),d.ButterBar.showMessage({text:"GMAX 正在发送邮件，你可以前往已发送标签查看。",time:5e3})):d.ButterBar.showMessage({text:"发送失败，请稍后重试！",time:1e4})}))})}else r(s)})}})})}catch(e){}})}},{"whatwg-fetch":1}]},{},[2]);